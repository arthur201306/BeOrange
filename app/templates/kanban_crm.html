{% extends "layout_sidebar.html" %}

{% block title %}Pipeline de Vendas - CRM{% endblock %}

{% block head_extra %}
    <style>
        /* Estilos base para o Kanban */
        .kanban-board {
            overflow-x: auto;
            white-space: nowrap;
            height: calc(100vh - 200px); 
            padding-bottom: 1rem;
        }
        .kanban-column {
            width: 300px;
            background-color: #eef2f6; /* Cor de fundo da coluna */
            margin-right: 1rem;
            white-space: normal;
            flex-shrink: 0;
        }
        
        /* Estilos de Card e Drag & Drop */
        .lead-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
        }
        .lead-card:active {
            cursor: grabbing;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05);
            transform: scale(1.01);
        }
        .drag-over {
            /* Estilo ao arrastar um card sobre a coluna */
            box-shadow: 0 0 0 4px #2563eb inset; 
        }

        /* Scrollbar customizada */
        .kanban-board::-webkit-scrollbar { height: 8px; }
        .kanban-board::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .kanban-board::-webkit-scrollbar-track { background: #f1f1f1; }

        /* Estilos de Modal */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .modal-hidden {
            /* Regra base de oculta칞칚o */
            display: none;
        }

        /* Menu de Contexto (Clique Direito) */
        #context-menu {
            z-index: 100;
        }
        
        /* 游뚿 CORRE칂츾O CSS FINAL: Garante que o item oculto dentro do menu de contexto permane칞a oculto. */
        #context-menu .modal-hidden {
            display: none !important; 
        }

    </style>
{% endblock %}

---

{% block content %}
    <h1 class="text-2xl font-semibold text-gray-800 mb-4">Pipeline de Vendas</h1>
        
    {% if error %}
        <div class="text-center text-red-600 font-semibold p-4 bg-red-100 border border-red-300 rounded-lg mb-4">
            <strong>Erro ao carregar dados:</strong> {{ error }}
        </div>
    {% endif %}

    <div id="board-container" class="kanban-board flex p-2">
    </div>

    <div id="confirmation-modal" class="modal-hidden">
        <div id="modal-backdrop" class="modal-backdrop"></div>
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-4">Confirmar Movimenta칞칚o</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Tem certeza que deseja mover este lead?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <div id="context-menu" class="modal-hidden absolute bg-white rounded-md shadow-lg py-1 w-48 border border-gray-200">
        <a href="#" id="context-menu-edit" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
            Editar Lead
        </a>
        <a href="#" id="context-menu-history" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
            Ver Hist칩rico
        </a>
        <div id="context-menu-separator" class="border-t border-gray-200 my-1 modal-hidden"></div>
        <a href="#" id="context-menu-post-sale" class="block px-4 py-2 text-sm text-green-700 hover:bg-green-50 hover:text-green-900 modal-hidden font-medium">
            Mover para P칩s-Venda
        </a>
    </div>

{% endblock %}

---

{% block scripts %}
    <script>
        // --- DADOS DIN츽MICOS INJETADOS PELO FLASK ---
        const initialLeads = {{ all_leads_json | tojson }};
        const stages = {{ all_stages_json | tojson }};
        const serverError = {{ error | tojson }};
        const areasColors = {{ areas_colors_json | tojson }};
        const defaultAreaColor = areasColors['default'] || 'text-gray-800 bg-gray-100';
        
        // 游뚿 CONFIGURA칂츾O: O ID do est치gio final em min칰sculas
        const FINALIZED_STAGE_ID = 'finalizado'; 
        
        // Mapeamento Seguro: Cria um mapa para busca r치pida e robusta
        const stageIdMap = new Map();
        stages.forEach(stage => {
            stageIdMap.set(stage.title.trim().toLowerCase(), stage.id.trim().toLowerCase());
        });
        
        // --- VARI츼VEIS DE ESTADO E DOM ---
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        let pendingMove = null;

        const contextMenu = document.getElementById('context-menu');
        const contextMenuEdit = document.getElementById('context-menu-edit');
        const contextMenuHistory = document.getElementById('context-menu-history');
        const contextMenuPostSale = document.getElementById('context-menu-post-sale');
        const contextMenuSeparator = document.getElementById('context-menu-separator');

        // --- FUN칂칏ES DE RENDERIZA칂츾O E DADOS ---

        function updateCardCount(stageId) {
            const container = document.getElementById(`cards-${stageId}`);
            const countDisplay = document.getElementById(`count-${stageId}`);
            if (container && countDisplay) {
                countDisplay.textContent = `${container.children.length} clientes/projetos`;
            }
        }
        
        function getAreaTagsHTML(areasArray) {
             if (!areasArray || areasArray.length === 0) return '';
             
             return areasArray.map(area => {
                 const colorClasses = areasColors[area] || defaultAreaColor;
                 return `<span class="inline-block px-2 py-0.5 ${colorClasses} rounded-full text-xs font-medium" title="${area}">
                             ${area}
                         </span>`;
             }).join('');
        }
        
        function createLeadCard(lead) {
            const card = document.createElement('div');
            card.id = `lead-${lead.id}`;
            card.classList.add('lead-card', 'p-4', 'bg-white', 'rounded-lg', 'shadow', 'mb-3', 'hover:shadow-md');
            card.setAttribute('draggable', 'true');
            card.setAttribute('data-lead-id', lead.id);
            card.setAttribute('data-lead-name', lead.nome_empresa || 'Novo Cliente');

            const leadEtapaCleanKey = lead.etapa ? lead.etapa.trim().toLowerCase() : '';
            const stageId = stageIdMap.get(leadEtapaCleanKey) || 'unknown'; 

            card.setAttribute('data-stage-id', stageId); 

            const displayDate = lead.created_at 
                ? new Date(lead.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) 
                : 'Sem data';

            const areaTagsHTML = getAreaTagsHTML(lead.areas);

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-800 text-sm">${lead.nome_empresa || 'Novo Cliente'}</h3>
                </div>
                <div class="flex flex-wrap gap-1 mb-3">
                    ${areaTagsHTML}
                </div>
                <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100">
                    <p class="text-xs text-gray-400">Owner: ${lead.responsavel?.nome || 'N/A'}</p>
                    <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${displayDate}</span>
                </div>
            `;

            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('contextmenu', handleRightClick);
            
            return card;
        }

        function loadLeads() {
            const leadData = {}; 
            stages.forEach(stage => leadData[stage.id.trim().toLowerCase()] = []); 

            if (!initialLeads || initialLeads.length === 0) {
                stages.forEach(stage => updateCardCount(stage.id.trim().toLowerCase()));
                return;
            }
            
            initialLeads.forEach(lead => {
                const leadEtapaCleanKey = lead.etapa ? lead.etapa.trim().toLowerCase() : '';
                const stageId = stageIdMap.get(leadEtapaCleanKey); 

                if (stageId && leadData[stageId]) {
                    leadData[stageId].push(lead);
                }
            });

            stages.forEach(stage => {
                const stageIdKey = stage.id.trim().toLowerCase();
                const container = document.getElementById(`cards-${stageIdKey}`); 
                if (!container) return;
                
                leadData[stageIdKey].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                leadData[stageIdKey].forEach(lead => {
                    container.appendChild(createLeadCard(lead));
                });
                
                updateCardCount(stageIdKey);
            });
        }

        // --- L칍GICA DE DRAG AND DROP ---
        let draggedLeadId = null;
        function handleDragStart(e) {
            draggedLeadId = e.target.getAttribute('data-lead-id');
            e.dataTransfer.setData('text/plain', draggedLeadId); 
            e.dataTransfer.setData('text/stage-origin', e.target.parentElement.id.replace('cards-', ''));
            e.dataTransfer.setData('text/lead-name', e.target.getAttribute('data-lead-name'));
            setTimeout(() => e.target.classList.add('opacity-50'), 0);
        }
        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
            document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));
        }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const newStageId = e.currentTarget.getAttribute('data-stage-id');
            const sourceStageId = e.dataTransfer.getData('text/stage-origin');
            const leadId = e.dataTransfer.getData('text/plain');
            const leadName = e.dataTransfer.getData('text/lead-name');
            
            if (!newStageId || !leadId || newStageId === sourceStageId) { return; }

            const targetStage = stages.find(s => s.id.trim().toLowerCase() === newStageId);
            
            pendingMove = {
                leadId: leadId,
                newStageId: newStageId,
                sourceStageId: sourceStageId,
                leadToMove: document.getElementById(`lead-${leadId}`)
            };
            
            modalTitle.textContent = `Mover "${leadName}"`;
            modalMessage.textContent = `Tem certeza que deseja mover este lead para a etapa "${targetStage.title}"?`;
            
            modalConfirmBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            modalConfirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

            modal.classList.remove('modal-hidden');
        }
        
        async function executeMove() {
            if (!pendingMove) return;

            const { leadId, newStageId, sourceStageId, leadToMove } = pendingMove;
            const destinationContainer = document.getElementById(`cards-${newStageId}`);
            
            const newStageTitle = stages.find(s => s.id.trim().toLowerCase() === newStageId)?.title;

            if (destinationContainer) {
                destinationContainer.appendChild(leadToMove);
                if (sourceStageId) updateCardCount(sourceStageId);
                updateCardCount(newStageId);
                leadToMove.setAttribute('data-stage-id', newStageId);
                
                leadToMove.classList.add('opacity-75', 'border-2', 'border-blue-500');

                try {
                    const response = await fetch("{{ url_for('main.update_lead_stage') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lead_id: leadId,
                            new_stage: newStageTitle 
                        })
                    });
                    
                    const result = await response.json();
                    leadToMove.classList.remove('opacity-75', 'border-2', 'border-blue-500');

                    if (!result.success) {
                        throw new Error(result.error || 'Erro desconhecido no servidor');
                    }
                } catch (error) {
                    console.error('Falha ao salvar atualiza칞칚o:', error);
                    alert('Erro ao salvar. Recarregando a p치gina para garantir a consist칡ncia.');
                    location.reload(); 
                }
            }
            
            pendingMove = null;
            modal.classList.add('modal-hidden');
        }
        
        function cancelMove() {
            pendingMove = null;
            modal.classList.add('modal-hidden');
        }
        
        // --- L칍GICA DO MENU DE CONTEXTO ---

        function hideContextMenu() {
            contextMenu.classList.add('modal-hidden');
            contextMenu.removeAttribute('data-lead-id');
            contextMenu.removeAttribute('data-stage-id');
        }

        // 游뚿 FUN칂츾O CORRIGIDA: L칅 O ID DA COLUNA PAI (MAIS EST츼VEL) E CONTROLA VISIBILIDADE
        function handleRightClick(e) {
            e.preventDefault(); 
            
            const leadCard = e.target.closest('.lead-card');
            if (!leadCard) {
                 hideContextMenu();
                 return;
            }

            const leadId = leadCard.getAttribute('data-lead-id');
            
            // L칅 O ID da COLUNA PAI
            const parentColumn = leadCard.closest('.kanban-column');
            const currentStageId = parentColumn ? parentColumn.getAttribute('data-stage-id') : 'unknown';
            
            contextMenu.setAttribute('data-lead-id', leadId);
            contextMenu.setAttribute('data-stage-id', currentStageId);
            
            // L칩gica: Se for FINALIZADO, MOSTRA. Se n칚o, ESCONDE.
            if (currentStageId === FINALIZED_STAGE_ID) {
                contextMenuPostSale.classList.remove('modal-hidden');
                contextMenuSeparator.classList.remove('modal-hidden');
            } else {
                contextMenuPostSale.classList.add('modal-hidden');
                contextMenuSeparator.classList.add('modal-hidden');
            }
            
            contextMenu.style.left = `${e.pageX + 5}px`;
            contextMenu.style.top = `${e.pageY + 5}px`;
            contextMenu.classList.remove('modal-hidden');
            
            e.stopPropagation();
        }
        
        // 游릭 FUN칂츾O DE P칍S-VENDA
        async function moveToPostSale() {
            console.log(contextMenu.getAttribute('data-lead-id'));

            const leadId = contextMenu.getAttribute('data-lead-id');
            
            hideContextMenu();

            if (!leadId) return; 

            const leadToMove = document.getElementById(`lead-${leadId}`);

            if (!leadToMove) {
                console.warn(`Tentativa de mover lead ${leadId}, mas o card j치 foi removido ou n칚o foi encontrado.`);
                alert(`O lead ID ${leadId} parece j치 ter sido movido. Por favor, recarregue a p치gina.`);
                return; 
            }
            
            const leadName = leadToMove.getAttribute('data-lead-name');

            if (!confirm(`Confirma mover o lead "${leadName}" para o P칩s-Venda? Esta a칞칚o o remover치 do Kanban de Vendas.`)) {
                return;
            }
            
            leadToMove.classList.add('opacity-50', 'border-2', 'border-green-500');

            try {
                const response = await fetch("{{ url_for('main.move_to_post_sale') }}", { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lead_id: leadId,
                    })
                });

                const result = await response.json();

                console.log(result);

                if (result.success) {
                    leadToMove.remove();
                    updateCardCount(FINALIZED_STAGE_ID);
                    alert(`Lead "${leadName}" movido com sucesso para o P칩s-Venda!`);
                } else {
                    alert('Erro ao mover para P칩s-Venda: ' + (result.error || 'Erro desconhecido.'));
                    leadToMove.classList.remove('opacity-50', 'border-2', 'border-green-500');
                }
            } catch (error) {
                console.error('Falha na comunica칞칚o com a API:', error);
                alert('Erro de rede ao mover para P칩s-Venda.');
                leadToMove.classList.remove('opacity-50', 'border-2', 'border-green-500');
            }
        }
        
        // --- MONTAGEM DO QUADRO ---
        function setupBoard() {
            const boardContainer = document.getElementById('board-container');
            
            if (!boardContainer) { 
                console.error("Elemento 'board-container' n칚o encontrado.");
                return; 
            }

            stages.forEach(stage => {
                const stageIdKey = stage.id.trim().toLowerCase(); // Garante que o ID do DOM est치 em min칰sculas
                const column = document.createElement('div');
                column.className = 'kanban-column rounded-lg flex flex-col p-4 shadow-lg';
                column.setAttribute('data-stage-id', stageIdKey); // Usa o ID em min칰sculas
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300 flex-shrink-0';
                header.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full ${stage.color} mr-2"></span>
                        <h2 class="font-bold text-sm text-gray-700">${stage.title}</h2>
                    </div>
                    <span id="count-${stageIdKey}" class="text-xs font-semibold text-gray-500 px-2 py-1 bg-gray-200 rounded-full">0</span>
                `;
                
                const cardsContainer = document.createElement('div');
                cardsContainer.id = `cards-${stageIdKey}`; 
                cardsContainer.className = 'flex-grow overflow-y-auto pt-2 space-y-3';
                
                column.appendChild(header);
                column.appendChild(cardsContainer);
                boardContainer.appendChild(column);
            });
            
            loadLeads();

            // --- LISTENERS GLOBAIS ---
            
            // Modal de Drag-and-Drop
            modalConfirmBtn.addEventListener('click', executeMove);
            modalCancelBtn.addEventListener('click', cancelMove);
            modalBackdrop.addEventListener('click', cancelMove);

            // Esconder Menu de Contexto
            window.addEventListener('click', hideContextMenu);
            window.addEventListener('contextmenu', hideContextMenu); 
            
            // A칞칫es do Menu de Contexto
            contextMenuEdit.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                const leadId = contextMenu.getAttribute('data-lead-id');
                if (leadId) {
                    window.location.href = `/leads/editar/${leadId}`;
                }
                hideContextMenu();
            });

            contextMenuHistory.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                const leadId = contextMenu.getAttribute('data-lead-id');
                if (leadId) {
                    alert(`Abrir hist칩rico do Lead ID: ${leadId}`);
                }
                hideContextMenu();
            });
            
            contextMenuPostSale.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); 
                moveToPostSale();
            });
        }

        document.addEventListener('DOMContentLoaded', setupBoard);
    </script>
{% endblock %}