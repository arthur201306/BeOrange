{% extends "layout_sidebar.html" %}

{% block title %}Pipeline de Vendas - CRM{% endblock %}

{% block head_extra %}
    <style>
        .kanban-board {
            overflow-x: auto;
            white-space: nowrap;
            /* Altura fixa para forçar colunas iguais */
            height: calc(100vh - 200px); 
            padding-bottom: 1rem;
        }
        .kanban-column {
            /* Removido CSS desnecessário (inline-block, min-height) */
            width: 300px;
            background-color: #eef2f6;
            margin-right: 1rem;
            white-space: normal;
        }
        .lead-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab;
        }
        .lead-card:active {
            cursor: grabbing;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: scale(1.01);
        }
        .drag-over {
            box-shadow: 0 0 0 4px #2563eb inset;
        }
        .kanban-board::-webkit-scrollbar { height: 8px; }
        .kanban-board::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .kanban-board::-webkit-scrollbar-track { background: #f1f1f1; }

        /* --- CSS PARA O MODAL (Inalterado) --- */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .modal-hidden {
            display: none;
        }
    </style>
{% endblock %}


{% block content %}
    <h1 class="text-2xl font-semibold text-gray-800 mb-4">Pipeline de Vendas</h1>
        
    <div id="areas-legend" class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4 p-3 bg-white rounded-lg shadow-sm border border-gray-200">
        </div>
        
    {% if error %}
        <div class="text-center text-red-600 font-semibold p-4 bg-red-100 border border-red-300 rounded-lg mb-4">
            <strong>Erro ao carregar dados:</strong> {{ error }}
        </div>
    {% endif %}

    <div id="board-container" class="kanban-board flex p-2">
        </div>

    <div id="confirmation-modal" class="modal-hidden">
        <div id="modal-backdrop" class="modal-backdrop"></div>
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-4">Confirmar Movimentação</h3>
            <p id="modal-message" class="text-gray-700 mb-6">Tem certeza que deseja mover este lead?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                    Cancelar
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

{% endblock %}


{% block scripts %}
    <script>
        // --- DADOS DINÂMICOS INJETADOS PELO FLASK ---
        const initialLeads = {{ all_leads_json | tojson }};
        const stages = {{ all_stages_json | tojson }};
        const serverError = {{ error | tojson }};
        const areasColors = {{ areas_colors_json | tojson }};
        const defaultAreaColor = areasColors['default'] || 'text-gray-800 bg-gray-100';

        // --- LÓGICA DE ESTADO DO MODAL ---
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalBackdrop = document.getElementById('modal-backdrop');
        let pendingMove = null;

        if (serverError && !initialLeads.length) {
            console.error("Erro vindo do Servidor (Python):", serverError);
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO DE DADOS ---
        function updateCardCount(stageId) {
            const container = document.getElementById(`cards-${stageId}`);
            const countDisplay = document.getElementById(`count-${stageId}`);
            if (container && countDisplay) {
                countDisplay.textContent = `${container.children.length} clientes/projetos`;
            }
        }
        
        /**
         * [FUNÇÃO CORRIGIDA]
         * Cria a legenda de áreas. As bolinhas agora terão cores fortes (sem borda).
         */
        function setupAreasLegend() {
            const legendContainer = document.getElementById('areas-legend');
            if (!legendContainer) return;

            let legendItemsHTML = '';
            for (const area in areasColors) {
                if (area === 'default') continue; 
                
                const colorClasses = areasColors[area];
                
                // [CORREÇÃO] Removida a borda que apagava a cor
                legendItemsHTML += `
                    <div class="flex items-center">
                        <span class="inline-block w-3 h-3 ${colorClasses} rounded-full mr-1.5"></span>
                        <span class="text-xs font-medium text-gray-600">${area}</span>
                    </div>
                `;
            }
            legendContainer.innerHTML = `<strong class="text-xs text-gray-500 uppercase mr-2">Áreas:</strong>` + legendItemsHTML;
        }


        /**
         * [FUNÇÃO CORRIGIDA]
         * Cria um card de lead. 
         * 1. Lida com 'areas' sendo string ou array (evita erro .map).
         * 2. Mostra "pontos" coloridos sem borda (para cor mais forte).
         */
        function createLeadCard(lead) {
            const card = document.createElement('div');
            card.id = `lead-${lead.id}`;
            card.classList.add('lead-card', 'p-4', 'bg-white', 'rounded-lg', 'shadow', 'mb-3', 'hover:shadow-md');
            card.setAttribute('draggable', 'true');
            card.setAttribute('data-lead-id', lead.id);
            card.setAttribute('data-stage', lead.etapa);
            card.setAttribute('data-lead-name', lead.nome_empresa || 'Novo Cliente');

            let displayDate = 'Sem data';
            if (lead.created_at) {
                displayDate = new Date(lead.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            // --- INÍCIO DA CORREÇÃO (Para erro .map() e cores) ---
            let areaTagsHTML = ''; 
            let areasArray = []; 

            if (lead.areas) {
                if (Array.isArray(lead.areas)) {
                    areasArray = lead.areas;
                } else if (typeof lead.areas === 'string') {
                    areasArray = [lead.areas];
                }
            }
            
            if (areasArray.length > 0) {
                areaTagsHTML = areasArray.map(area => {
                    const colorClasses = areasColors[area] || defaultAreaColor;
                    // [CORREÇÃO] Removida a borda que apagava a cor
                    return `<span class="inline-block w-3 h-3 ${colorClasses} rounded-full mr-1" title="${area}"></span>`;
                }).join('');
            }
            // --- FIM DA CORREÇÃO ---

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-gray-800 text-sm">${lead.nome_empresa || 'Novo Cliente'}</h3>
                </div>
                
                <div class="flex justify-between items-center mb-3">
                    <div class="flex-wrap">
                        ${areaTagsHTML}
                    </div>
                    <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${displayDate}</span>
                </div>

                <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100">
                    <p class="text-xs text-gray-400">Owner: ${lead.responsavel || 'N/A'}</p>
                    <div class="flex space-x-1"></div>
                </div>
            `;
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            return card;
        }

        /**
         * [FUNÇÃO CORRIGIDA]
         * Carrega os leads, traduzindo 'title' (do dado) para 'id' (da coluna).
         */
        function loadLeads() {
            
            // 1. Crie um mapa de Título -> ID
            const stageTitleToIdMap = {};
            stages.forEach(stage => {
                stageTitleToIdMap[stage.title] = stage.id;
            });

            // 2. Inicialize os "baldes" de leads USANDO O ID
            const leadData = {}; 
            stages.forEach(stage => leadData[stage.id] = []);

            if (!initialLeads || initialLeads.length === 0) {
                if(!serverError) console.warn('Nenhum lead recebido do servidor.');
                stages.forEach(stage => updateCardCount(stage.id));
                return;
            }
            
            // 3. Ao processar os leads, use o mapa para encontrar o ID correto
            initialLeads.forEach(lead => {
                const leadStageTitle = lead.etapa; 
                const stageId = stageTitleToIdMap[leadStageTitle]; 

                if (leadData[stageId]) {
                    leadData[stageId].push(lead);
                } else if(leadStageTitle) { 
                    console.warn(`Lead ${lead.id} tem uma etapa desconhecida: '${leadStageTitle}' (Não foi encontrada no mapa)`);
                }
            });

            // 4. Renderiza os cards
            stages.forEach(stage => {
                const container = document.getElementById(`cards-${stage.id}`); 
                if (!container) return;
                
                leadData[stage.id].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                leadData[stage.id].forEach(lead => {
                    container.appendChild(createLeadCard(lead));
                });
                
                updateCardCount(stage.id);
            });
        }

        // --- LÓGICA DE DRAG AND DROP (Inalterada) ---
        let draggedLeadId = null;

        function handleDragStart(e) {
            draggedLeadId = e.target.getAttribute('data-lead-id');
            e.dataTransfer.setData('text/plain', draggedLeadId); 
            e.dataTransfer.setData('text/stage-origin', e.target.parentElement.id.replace('cards-', ''));
            e.dataTransfer.setData('text/lead-name', e.target.getAttribute('data-lead-name'));
            setTimeout(() => e.target.classList.add('opacity-50'), 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
            document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('drag-over'));
        }

        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const newStageId = e.currentTarget.getAttribute('data-stage-id');
            const sourceStageId = e.dataTransfer.getData('text/stage-origin');
            const leadId = e.dataTransfer.getData('text/plain');
            const leadName = e.dataTransfer.getData('text/lead-name');
            
            if (!newStageId || !leadId || newStageId === sourceStageId) {
                return;
            }

            const sourceIndex = stages.findIndex(s => s.id === sourceStageId);
            const targetIndex = stages.findIndex(s => s.id === newStageId);
            
            if (sourceIndex === -1 || targetIndex === -1) {
                console.error("Etapa de origem ou destino desconhecida.");
                return;
            }

            if (Math.abs(targetIndex - sourceIndex) > 1) {
                alert('Movimentação Inválida!\n\nNão é permitido pular etapas. Mova o lead para uma etapa adjacente.');
                return;
            }

            pendingMove = {
                leadId: leadId,
                newStageId: newStageId,
                sourceStageId: sourceStageId,
                leadToMove: document.getElementById(`lead-${leadId}`)
            };
            
            const targetStage = stages[targetIndex];
            modalTitle.textContent = `Mover "${leadName}"`;
            modalMessage.textContent = `Tem certeza que deseja mover este lead para a etapa "${targetStage.title}"?`;
            modal.classList.remove('modal-hidden');
        }

        async function executeMove() {
            if (!pendingMove) return;

            const { leadId, newStageId, sourceStageId, leadToMove } = pendingMove;
            const destinationContainer = document.getElementById(`cards-${newStageId}`);

            if (destinationContainer) {
                // 1. UI Otimista
                destinationContainer.appendChild(leadToMove);
                if (sourceStageId) updateCardCount(sourceStageId);
                updateCardCount(newStageId);
                leadToMove.setAttribute('data-stage', newStageId);
                
                console.log(`Enviando atualização para o servidor: Lead ${leadId} -> ${newStageId}`);
                leadToMove.classList.add('opacity-75', 'border-2', 'border-blue-500');

                // 2. Chama a API
                try {
                    const response = await fetch("{{ url_for('main.update_lead_stage') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lead_id: leadId,
                            new_stage: newStageId
                        })
                    });
                    
                    const result = await response.json();
                    leadToMove.classList.remove('opacity-75', 'border-2', 'border-blue-500');

                    if (!result.success) {
                        throw new Error(result.error || 'Erro desconhecido no servidor');
                    }
                    console.log('Atualização salva no servidor.');

                } catch (error) {
                    console.error('Falha ao salvar atualização:', error);
                    alert('Erro ao salvar. Recarregando a página para garantir a consistência.');
                    location.reload(); 
                }
            }
            
            pendingMove = null;
            modal.classList.add('modal-hidden');
        }

        function cancelMove() {
            pendingMove = null;
            modal.classList.add('modal-hidden');
        }
        
        // --- MONTAGEM DO QUADRO ---
        function setupBoard() {
            const boardContainer = document.getElementById('board-container');
            if (!boardContainer) { 
                console.error("Elemento 'board-container' não encontrado.");
                return; 
            }

            // Chama a função que constrói a legenda
            setupAreasLegend();
            
            stages.forEach(stage => {
                const column = document.createElement('div');
                // Adiciona 'flex flex-col' para que a coluna use flexbox internamente
                column.className = 'kanban-column rounded-lg flex flex-col p-4 shadow-lg';
                column.setAttribute('data-stage-id', stage.id); 
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
                
                const header = document.createElement('div');
                // 'flex-shrink-0' previne que o header encolha
                header.className = 'flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300 flex-shrink-0';
                header.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-3 h-3 rounded-full ${stage.color} mr-2"></span>
                        <h2 class="font-bold text-sm text-gray-700">${stage.title}</h2>
                    </div>
                    <span id="count-${stage.id}" class="text-xs font-semibold text-gray-500 px-2 py-1 bg-gray-200 rounded-full">0</span>
                `;
                
                const cardsContainer = document.createElement('div');
                cardsContainer.id = `cards-${stage.id}`; 
                // 'flex-grow' faz o container de cards ocupar todo o espaço restante
                // 'overflow-y-auto' adiciona scroll SÓ a este container
                cardsContainer.className = 'flex-grow overflow-y-auto pt-2 space-y-3';
                
                column.appendChild(header);
                column.appendChild(cardsContainer);
                boardContainer.appendChild(column);
            });
            
            loadLeads();

            modalConfirmBtn.addEventListener('click', executeMove);
            modalCancelBtn.addEventListener('click', cancelMove);
            modalBackdrop.addEventListener('click', cancelMove);
        }

        // Inicia o app
        document.addEventListener('DOMContentLoaded', setupBoard);
    </script>
{% endblock %}