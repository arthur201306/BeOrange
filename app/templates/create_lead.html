{% extends "layout_sidebar.html" %}

{% block title %}Criar Novo Lead{% endblock %}

{% block page_title %}
    Criar Novo Lead
{% endblock %}

{% block header_actions %}
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        
        <form id="create-lead-form" 
              method="POST" 
              action="{{ url_for('main.create_lead_page') }}">

            <div class="p-6 md:p-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Informações do Cliente</h2>
            
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="md:col-span-2">
                        <label for="nome_empresa" class="block text-sm font-medium text-gray-700">Nome da Empresa</label>
                        <input type="text" name="nome_empresa" id="nome_empresa" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" 
                               placeholder="Ex: Acme Inc."
                               required>
                    </div>

                    <div>
                        <label for="nome_contato" class="block text-sm font-medium text-gray-700">Nome do Contato</label>
                        <input type="text" name="nome_contato" id="nome_contato" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                               placeholder="Ex: Maria Silva"
                               required>
                    </div>
                    
                    <div>
                        <label for="telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
                        <input type="tel" name="telefone" id="telefone" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                               placeholder="Ex: (41) 99999-8888">
                    </div>

                    <div class="md:col-span-2">
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" id="email" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                               placeholder="Ex: maria.silva@acme.com">
                    </div>

                    </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-4 border-t border-gray-200">
                <div id="form-feedback" class="text-sm font-medium flex-1 items-center flex">&nbsp;</div>

                <a href="{{ url_for('main.kanban_board') }}" class="px-5 py-2 rounded-lg text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 transition duration-150">
                    Cancelar
                </a>
                <button type="submit" id="submit-button" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md text-sm font-medium flex items-center">
                    <span id="submit-text">Salvar Lead</span>
                    <svg id="submit-spinner" class="animate-spin -mr-1 ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </form>
    </div>

    <div id="success-message" class="hidden mt-6 p-4 rounded-lg bg-green-50 border-l-4 border-green-500">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1.707-5.293a1 1 0 010-1.414L10 9.586l1.707-1.707a1 1 0 011.414 1.414L11.414 11l1.707 1.707a1 1 0 01-1.414 1.414L10 12.414l-1.707 1.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800">Lead Criado com Sucesso!</h3>
                <p class="text-sm text-green-700 mt-1">O novo lead foi salvo e adicionado ao quadro Kanban.</p>
                <a href="{{ url_for('main.kanban_board') }}" class="text-sm font-medium text-green-800 hover:text-green-600 mt-2 inline-block">Voltar para o Kanban</a>
            </div>
        </div>
    </div>
</div>

<script>
    // Executa quando o HTML da página estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('create-lead-form');
        const feedback = document.getElementById('form-feedback');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const successMessage = document.getElementById('success-message');

        form.addEventListener('submit', async (event) => {
            // 1. Impede o envio padrão (que recarrega a página)
            event.preventDefault();

            // 2. Mostra o feedback de "carregando"
            feedback.textContent = '';
            feedback.classList.remove('text-red-600', 'text-green-600');
            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');

            // 3. Coleta os dados do formulário
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                // 4. Envia os dados para a API que criamos
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) { // Status 200-299
                    // 5a. SUCESSO!
                    form.classList.add('hidden'); // Esconde o formulário
                    successMessage.classList.remove('hidden'); // Mostra a caixa de sucesso
                    
                    // Opcional: Redireciona após um tempo
                    setTimeout(() => {
                        window.location.href = "{{ url_for('main.kanban_board') }}";
                    }, 3000); // 3 segundos

                } else {
                    // 5b. ERRO! (Ex: Validação falhou, erro no servidor)
                    throw new Error(result.error || 'Falha ao salvar o lead.');
                }

            } catch (error) {
                // 5c. Erro de rede ou o 'throw' acima
                feedback.textContent = `Erro: ${error.message}`;
                feedback.classList.add('text-red-600');
                
                // Reabilita o botão para nova tentativa
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });
    });
</script>
{% endblock %}