{% extends "layout_sidebar.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}

<h1 class="text-2xl font-semibold text-gray-800 mb-6">{{ page_title }}</h1>

{% if history_data %}

<!-- TIMELINE -->
<div class="relative border-l-4 border-blue-400 ml-4">

    {% for item in history_data %}
    <div class="mb-12 ml-6 relative">

        <!-- Ponto da timeline -->
        <span class="absolute -left-3 w-6 h-6 bg-blue-500 rounded-full ring-8 ring-blue-100"></span>

        <!-- CARD -->
        <div class="bg-white rounded-xl shadow p-5 border border-gray-200">

            <!-- Cabeçalho -->
            <div class="flex justify-between items-center mb-3">
                <div>
                    <p class="text-gray-600 text-sm">
                        {{ item.data_acao | default("N/A") }}
                    </p>
                    <p class="text-lg text-gray-800 font-semibold mt-1">
                        {{ item.detalhes }}
                    </p>
                </div>

                <!-- Tag por tipo de ação -->
                <span class="
                    px-3 py-1 text-xs font-bold rounded-full
                    {% if item.tipo_acao == 'UPDATE' %}
                        bg-yellow-100 text-yellow-800
                    {% elif item.tipo_acao == 'CREATE' %}
                        bg-green-100 text-green-800
                    {% elif item.tipo_acao == 'DELETE' %}
                        bg-red-100 text-red-800
                    {% else %}
                        bg-gray-100 text-gray-700
                    {% endif %}
                ">
                    {{ item.tipo_acao }}
                </span>
            </div>

            <!-- ALTERAÇÕES DETALHADAS -->
            <div class="mt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Alterações realizadas</h3>

                {% set antes = item.dados_antes or {} %}
                {% set depois = item.dados_depois or {} %}

                {% set mudou = false %}
                <ul class="space-y-3">

                    {% for campo, valor_antes in antes.items() %}
                        {% if depois[campo] != valor_antes %}
                            {% set mudou = true %}

                            <li class="p-3 rounded-lg border bg-yellow-50 border-yellow-200 text-sm">
                                <span class="font-semibold text-gray-700">
                                    {{ campo | replace("_", " ") | title }}
                                </span>

                                <div class="mt-1">

                                    <!-- Antes -->
                                    <span class="text-gray-500 line-through">
                                        {{ valor_antes if valor_antes else "—" }}
                                    </span>

                                    <span class="mx-2 text-gray-400">→</span>

                                    <!-- Depois -->
                                    <span class="text-green-700 font-semibold">
                                        {{ depois[campo] if depois[campo] else "—" }}
                                    </span>

                                </div>
                            </li>

                        {% endif %}
                    {% endfor %}
                </ul>

                {% if not mudou %}
                    <p class="text-sm text-gray-500">
                        Nenhuma mudança relevante foi registrada nesse evento.
                    </p>
                {% endif %}
            </div>

        </div>
    </div>
    {% endfor %}

</div>

{% else %}

<!-- SEM HISTÓRICO -->
<div class="p-6 text-center text-gray-600 bg-gray-100 rounded-lg border-dashed border-2 border-gray-300">
    <p class="font-semibold mb-2">Sem Histórico de Auditoria</p>
    <p>Não foram encontradas ações registradas para este cliente.</p>
</div>

{% endif %}

{% endblock %}
